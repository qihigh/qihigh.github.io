<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>后台经验</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.14" />
  <link href="" rel="alternate" type="application/rss+xml" title="齐欢的博客" />
  <link href="http://qihigh.github.io//css/bootstrap.min.css" rel="stylesheet">
  <link href="http://qihigh.github.io//css/hc.css" rel="stylesheet">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  
    
    </head>
    <body>
<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
      <div id = "wrapper">


<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="http://qihigh.github.io//"><p class="navbar-brand">齐欢的博客</p></a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
					
					
					<li><a href="http://qihigh.github.io/">1.所有 </a></li>
					
					<li><a href="http://qihigh.github.io/android/">2.安卓 </a></li>
					
					<li><a href="http://qihigh.github.io/back/">3.后台 </a></li>
					
					<li><a href="http://qihigh.github.io/about/">4.关于 </a></li>
					
          </ul>
        </div>
      </div>
    </div>



       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="https://avatars0.githubusercontent.com/u/1587551?v=3&amp;s=460" />
          <li class="sidebar-brand"><a href="http://qihigh.github.io//"><h1 class="brand">齐欢的博客</h1></a><h3></h3></li>
          <hr />
					
						<li><a href="http://qihigh.github.io/android/">2.安卓 </a></li>
					
						<li><a href="http://qihigh.github.io/back/">3.后台 </a></li>
					
						<li><a href="http://qihigh.github.io/about/">4.关于 </a></li>
					
						<li><a href="http://qihigh.github.io/">1.所有 </a></li>
					
          <hr />
          <div id="social-wrapper">
           
           
           
           
         </div>
       </ul>
     </div>



     <div class="container">


  <div id="article">
   <div class="article-title">后台经验</div>
   <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2015-10-26</small></p> <hr/>
   <div class="post">
     

<p>###ssh
使用天宇发过来的rsa进行登录
<code>ssh -i ~/.ssh/weico_rsa root@xxx.xxx.xxx.xxx</code>
chmod 600 weico_rsa 你要改下权限</p>

<p>###服务器
1.  Linode</p>

<blockquote>
<p><code>ssh -i ~/workspace/weico_rsa root@106.185.52.238 -p 1010</code>
        weiconote海外</p>
</blockquote>

<p>###工具</p>

<ol>
<li><p>压缩命令 tar</p>

<blockquote>
<p>压缩muma_web，文件名为web.tar.gz，压缩方式为gzip
<code>tar -czvf web.tar.gz muma_web</code></p>
</blockquote></li>

<li><p>复制命令</p>

<blockquote>
<p>本地到远程
<code>
scp -i ~/workspace/weico_rsa temp.txt deployer@42.62.2.58:/home/deployer/temp.txt
</code>
颠倒一下 远程到本地
<code>
scp -i ~/workspace/weico_rsa deployer@42.62.2.58:/home/deployer/temp.txt 1.txt
</code></p>
</blockquote></li>

<li><p>ssh服务器端</p>

<blockquote>
<p>弄个ssh-copy-id
<code>ssh-copy-id -i ~/.ssh/id_rsa.pub user@server</code>
类似这样，把你的key全部加一下</p>
</blockquote></li>

<li><p>ps查看所有用户运行的程序，和top类似，但是只查看一瞬间</p>

<blockquote>
<pre>
[weico3@localhost project]$ ps aux|grep deployer
deployer  5786  0.0  0.0 108460  1008 pts/2    Ss+  Jul06   0:00 -bash
deployer  6427  0.0  0.0  28916  1256 ?        Ss   Mar09  68:08 tmux new -s devel
deployer  6428  0.0  0.0 108460     0 pts/7    Ss   Mar09   0:00 -bash
deployer  6445  0.0  0.0 199840   104 pts/7    S+   Mar09   0:00 mysql -uroot
weico3   13004  0.0  0.0 103260   592 pts/1    S+   15:50   0:00 grep deployer
    </pre>
</blockquote></li>

<li><p>mysql -uroot -p是什么命令</p>

<blockquote>
<p>这个是登mysql登陆数据库的命令，如果你使用黑窗口(DOS)的话就要这个命令进入数据库。</p>
</blockquote></li>

<li><p>ll 命令</p>

<blockquote>
<p>ll 命令列出的信息更加详细，有时间，是否可读写等信息 , 和ls相比，ll会列出该文件下的所有文件信息，包括隐藏的文件，而ls -l只列出显式文件，说明这两个命令还是不等同的！</p>
</blockquote></li>

<li><p>git cherry-pick 命令介绍.</p>

<p>简单来说：git cherry-pick用于把另一个本地分支的commit修改应用到当前分支。</p>

<blockquote>
<p>应用中,当开发在master分支时，而服务器运行的代码在server分支。这样当需要发布新版本时，需要首先到服务器端代码部分，执行以下命令，来使master分支代码到server分支，同时更新服务器端代码到最新。
<code></p>

<h1 id="bin-sh:b7d8c5818853d24675f2be77c2ebb7c4">/bin/sh</h1>

<p>git checkout master
git pull
git checkout server
git cherry-pick master
</code></p>
</blockquote></li>

<li><p>建立一个新的代码库</p>

<p><code>$ sudo git init --bare sample.git</code></p>

<p>添加新的用户,需要在.ssh/authorized_keys中添加用户的id_rsa.pub文件。</p></li>

<li><p>go语言部分主要是hot部分。
42.62.2.62上的go服务分析。</p>

<ul>
<li>使用go的beego框架，redis框架，和beego依赖的框架如mysql等，已经成功在本地运行。</li>
<li>go语言使用的mysql是42.62.2.62的数据库，配置文件中直接配置的是本地，端口是默认的3306。
用户名密码有两个，一个是空密码的root，一个是weico3密码是ef86157.<br/>
go链接数据库的配置是一行 <code>weico3:ef86157@tcp(127.0.0.1:3306)/weico3_dev?charset=utf8</code></li>
<li>42.62.2.62在DnsPod上映射的域名是weico3，二级域名是weico.cc。端口是go配置文件app.conf中的8080，
但是这部分并不能直接通过ip+端口来进行访问，在服务器42.62.2.62上，是通过nginx来进行分发处理的。</li>
<li>查看nginx的配置文件（配置文件位置通过命令 nginx -t 来找到）。配置文件nginx.conf中引用了ttt.conf,
而ttt.conf文件开头的
<code>
upstream ttt{
server 127.0.0.1:8080;
}
</code>
定义了一个负载均衡。
在server部分又监听80端口，定义了域名访问weico3.weico.cc,将所有请求<code>proxy_pass http://ttt;</code>转给了ttt，完成了到go服务的请求</li>
<li>个人猜测：数据库部分,go语言部分代码仅仅提供了对外的api，从数据库中读取数据；数据库的写入部分是weico_admin_v3部分来完成的。</li>
</ul></li>

<li><p>添加ssh到服务器</p>

<blockquote>
<p>实际使用的时候，其实就是将本地的id_rsa.pub添加到服务器的 authorized_keys 中</p>
</blockquote>

<pre>
# ssh-keygen -t rsa (连续三次回车,即在本地生成了公钥和私钥,不设置密码)
# ssh root@172.24.253.2 "mkdir .ssh;chmod 0700 .ssh" (需要输入密码)
# scp ~/.ssh/id_rsa.pub root@172.24.253.2:.ssh/id_rsa.pub (需要输入密码)
然后在B上的命令:
# touch /root/.ssh/authorized_keys (如果已经存在这个文件, 跳过这条)
# cat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys (将id_rsa.pub的内容追加到 authorized_keys 中)
回到A机器:
# ssh root@172.24.253.2 (因为没有设置私钥密码, 所以不需要密码, 登录成功) </pre></li>

<li><p>部署weico3到服务器端，进行相关的处理
<pre>
//linux平台编译
GOOS=linux GOARCH=amd64 go build</p>

<p>//上传新的包
scp -i ~/workspace/weico_rsa weico3 root@42.62.2.62:/mnt/tfs7/weico3/go/src/com.weico/weico3_new</p>

<p>//杀掉weico3进程
kill -s 9 $1
//重命名
mv weico3 weico3_old
mv weico3_new weico3
chmod 777 weico3
//切换用户
su weico3
//不挂起启动
nohup ./weico3 &amp;
</pre></p></li>

<li><p>清理redis指定key的缓存</p>

<p>删除所有weico开头的缓存 <code>redis-cli keys &quot;weico*&quot; | xargs redis-cli del</code></p></li>

<li><p>得到服务器的对外端口</p>

<p>是否开启了21端口: <code>netstat -ntpl|grep 21</code></p>

<p>结果显示
<code>tcp6       0      0 :::21                   :::*                    LISTEN      27660/vsftpd</code></p></li>

<li><p>git服务器地址迁移。</p>

<p>迁移git服务器其实很简单，在新的服务器上初始化新的git包，或者直接将原来的git包复制过来即可。在客户端，需要修改一下remote地址</p>

<p>新的服务器地址是<code>dev.weico.com</code>，代码放在android用户目录下，最后拼装成新的git地址是:</p>

<p><code>git clone root@dev.weico.com:/home/android/WeicoTV.git</code></p>

<p>在本地项目目录下，首先移除原来的remote地址:</p>

<p><code>git remote remove origin</code></p>

<p>然后添加新的remote地址:</p>

<p><code>git remote add origin root@dev.weico.com:/home/android/WeicoTV.git</code></p>

<p>重新push一下即可，这样会将本地所有的修改提交到新的服务器上。（服务器端采用复制git包或者重新初始化git包的方式，都可以将代码更新成最新的）</p></li>

<li><p>创建用户 centos</p>

<ul>
<li><p>首先添加用户组</p>

<p>groupadd deployer</p></li>

<li><p>添加新用户</p>

<p>useradd -d /home/weico -g deployer weico</p></li>

<li><p>新用户设置密码</p>

<p>passwd weico</p></li>
</ul></li>

<li><p>ucloud 开放的端口3389，是针对window系统的，这里可以用来测试一些服务，跳过nginx配置</p>

<p>./gohttp &ndash;root . &ndash;port 3389</p></li>

<li><p>查看已经被删除的句柄</p>

<p>lsof | grep deleted</p></li>

<li><p>nginx路径配置匹配规则</p>

<p>nginx location语法
基本语法：location [=|~|~*|^~] /uri/ { … }</p>

<p>= 严格匹配。如果这个查询匹配，那么将停止搜索并立即处理此请求。
~ 为区分大小写匹配(可用正则表达式)
!~为区分大小写不匹配
~* 为不区分大小写匹配(可用正则表达式)
!~*为不区分大小写不匹配
^~ 如果把这个前缀用于一个常规字符串,那么告诉nginx 如果路径匹配那么不测试正则表达式。</p></li>
</ol>

   </div>
 </div>

 <ul class="pager">
      &nbsp;<li class="previous"><a href="http://qihigh.github.io/back/mysql_dump/"> Mysql导出表结构及表数据 mysqldump用法</a></li>
      &nbsp;<li class="next"><a href="http://qihigh.github.io/android/flux_study/"> 尝试研究自己的flux架构</a></li>
</ul>



    </ul>
    </div>
    <footer>

        <p class="text-muted credit">&copy; . All rights reserved. </p>
    </footer>
 
    <script src="/js/jquery-1.10.2.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/bootstrap.js"></script>
    <script type="text/javascript" src="/js/hc.js"></script>
</body>

</html>

